<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>D3.js Map</title>
    <style>
        path {
            fill: #ccc;
            stroke: #fff;
            stroke-width: 1;
        }


    .grabbing {
      cursor: grabbing;
    }
    
    .filter.selected {
        color: #fff;
        background-color: #E45E00;
    }
    
    p.description {
        font-size: 16px;
        margin: 5px 0;
    }
    
    p.attr {
        font-size: 14px;
    }
    
    #filter-container {
        display: flex;
        gap: 5px;
    }
    
    .filter {
        /* display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center; */
        padding: 7px 11px 6px;
        font-size: 13px;
        border-radius: 4px;
        border: none;
        background: rgb(230,230,230);
        width: max-content;
        /* transition: all .2s ease; */
        white-space: nowrap;
        cursor: pointer;
        user-select: none;
    }
    
    #All:hover:not(.selected) {
        background-color: rgba(0,0,0,0.5);
    }
    #Shein:hover:not(.selected) {
        background-color: rgba(227, 41, 28,0.5);
    }
    
    #Temu:hover:not(.selected){
        background-color: rgba(239, 127, 49,0.5);
    }
    
    #TikTok:hover:not(.selected) {
        background-color: rgba(58, 176, 145,0.5);
    }
    
    #Alibaba:hover:not(.selected) {
        background-color: rgba(255, 151, 254,0.5);
    }
    
    #All.selected {
        color: #fff;
        background-color: #000;
    }
    
    #Shein.selected {
        color: #fff;
        background-color: #E3291C;
    }
    
    #Temu.selected {
        color: #fff;
        background-color: #E45E00;
    }
    
    #TikTok.selected {
        color: #fff;
        background-color: #3AB091;
    }
    
    #Alibaba.selected {
        color: #fff;
        background-color: #FF97FE;
    }
    
    
          h1, h2, p{
        font-family: "Moderat",sans-serif;
      }
    
      h1 {
        font-size: 20px;
      }
    
      h2 {
        font-size: 14px;
        color: #666;
        font-weight: 400;
      }
    
    
      div.container {
        margin: 0;
        display: inline-block;
        width: fit-content;
      }
    
      div.table {
        padding: 0;
        display: flex;
        width: fit-content;
        flex-wrap: wrap;
      }
    
      div.table > p {
        margin: 5px 0;
        flex: 0 0 calc(50% - 10px);
      }
    
      span.label {
        font-size: 11px;
        display: block;
        color: #494949
      }

      .line {
        stroke-dasharray: 4, 2;
        stroke-width: 1;
      }
    
        #tooltip {
            background-color: white;
            padding: 10px;
            border: 1px solid #a8a8a8;
            /* border-top: 5px solid #E45E00; */
            border-top: 5px solid black;
            border-radius: 4px;
            display: inline-block;
            position: fixed;
            width: 250px;
        }
        circle {
            cursor: pointer;
        }
        #body-container {
    width: 100%;
    max-width: 980px; /* Set a max-width to control the map's maximum size */
    height: 450px;
}
#map-container {
    height: 450px;
    width: inherit;
  overflow-x: auto; /* Enable horizontal scrolling */
  white-space: nowrap; /* Prevent SVG from wrapping to a new line */
}

#map {
  margin-top: 10px;
  display: block;
  margin: 0 auto;
  overflow-x: auto; /* Enable horizontal scrolling */

  width: 980px;
    height: inherit; /* Make the height responsive based on the width */
}
    </style>
</head>
<body>
    <div id="body-container">
        <h1>Chinese e-commerce companies moving out of China</h1>
        <div id="filter-container"></div>
        <div id="tooltip" style="display: none;"></div>
        <div id="map-container">
            <svg id="map"></svg>
        </div>
    </div>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script>

function drawMap(){

    let svg_container = d3.select("#map"),
    width = 980,
    height = svg_container.node().clientHeight;

    console.log(width);


// Create an SVG element and set its dimensions
// const width = window.innerWidth;
// const height = window.innerHeight;

const chinaCenter = [104.1954, 35.8617]; 

const svg = svg_container
    .attr("width", width)
    .attr("height",height)

    let colorDict = {
    "Shein":"#E3291C",
    "Temu":"#E45E00",
    "TikTok":"#3AB091",
    "Alibaba":"#FF97FE"
}

// Create a Mercator projection for the map
const projection = d3.geoNaturalEarth1(); //.rotate([-100, -15]);

// Create a path generator
const path = d3.geoPath().projection(projection);

function returnData(d){

// console.log(d);

return `<div class="container ${d.Grouping}">
    <p class="description">${d.Description}</p>   
    <div class="table">
    <p class="attr"><span class="label">App</span> ${d.App}</p>
    <p class="attr"><span class="label">Company</span> ${d['Parent company']}</p>    
    <p class="attr"><span class="label">Location</span> ${d.Location}</p>   
    <p class="attr"><span class="label">Year</span> ${d.Year}</p>   
    <p class="attr"><span class="label">Function</span> ${d.Classification}</p>  
    </div>
 </div>
    `
}

let filterContainer = document.getElementById('filter-container');


function makeButtons(companyNames) {
            let element = 'All'
            let button = document.createElement('button');
                button.className = `filter selected`;
                button.id = `${element}`;
                button.textContent = element;
                filterContainer.appendChild(button);

            for (let index = 0; index < companyNames.length; index++) {
                let element = companyNames[index];
                let button = document.createElement('button');
                button.className = `filter`;
                button.id = `${element}`;
                button.textContent = element;
                filterContainer.appendChild(button);
            }

        }




function hideTooltip() {
    d3.select("#tooltip")
        .style("display", "none");
}






// Load the world map data
d3.json("world_2.json").then(function (world) {
    // Append the countries to the SVG
    svg.selectAll("path")
        .data(world.features)
        .enter()
        .append("path")
        .attr("d", path);

        function showTooltip(d) {
    // Get the coordinates for the tooltip
    var [x, y] = return_Centeroid(d.Location);




    // Show the tooltip at the coordinates

    let containerWidth = document.getElementById('map-container').clientWidth / 2;
    

    if (document.getElementById('map-container').clientWidth < 980) {
        d3.select("#tooltip")
        .style("display", "block")
        .style("left", (x - (containerWidth - 70)) + "px")
        .style("top", (y + 100) + "px")
        .html(returnData(d));
    }
    else {
        if (x >= containerWidth){
        d3.select("#tooltip")
        .style("display", "block")
        .style("left", (x - 280) + "px")
        .style("top", (y + 20) + "px")
        .html(returnData(d));
        }
        else {
            d3.select("#tooltip")
            .style("display", "block")
            .style("left", (x + 20) + "px")
            .style("top", (y + 20) + "px")
            .html(returnData(d));

        }

    }




}

        function return_Centeroid(country_name){


simp_country = world.features.find(function(nation) {
    return nation.properties.name === country_name;
});

country = path.centroid(simp_country)
return country;


}

function redrawDots(data){

svg.selectAll(".point").remove();

svg.selectAll(".line").remove();



    function getArch(source,target) {
        var dx = target[0] - source[0],
            dy = target[1] - source[1],
            dr = Math.sqrt(dx * dx + dy * dy);
        return "M" + source[0] + "," + source[1] + "A" + dr + "," + dr +
    " 0 0,1 " + target[0] + "," + target[1];
    }

    svg.selectAll(".line")
    .data(data)
    .enter()
    .append("path")
    .attr("class", "line")
    .attr("d", function(d) {
            return getArch(projection(chinaCenter),return_Centeroid(d.Location));
        })
    //   .attr("x1", projection(chinaCenter)[0])
    //   .attr("y1", projection(chinaCenter)[1])
    //   .attr("x2", d => return_Centeroid(d.Location)[0])
    //   .attr("y2", d => return_Centeroid(d.Location)[1])
    .style("stroke", function (d) { return colorDict[d.Grouping]})
    .style('fill',"none");

    // console.log(markers);
    var points = svg.selectAll(".point")
    .data(data)
    .enter()
    .append("circle")
    .attr("class", "point")
    .attr('data-city', (d) => d.Location)
    .attr("r", 5)                
    .attr("transform", function (d) {
    var coords = return_Centeroid(d.Location);
    return "translate(" + coords + ")";
    }).style("fill", function (d) { return colorDict[d.Grouping]})

    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

    if (isTouchDevice) {
    // Handle touch events (e.g., tap or touchstart)
    svg.selectAll(".point").on('touchstart', function (event, d) {
    showTooltip(d);
    });
    } else {
    // Handle mouse events (e.g., mouseover)
    svg.selectAll(".point")
    .on("mouseover", function (event, d) {
    showTooltip(d);
    })
    .on("mouseout", hideTooltip);
        // Your mouse event handling logic here
    };
    








}



        d3.csv("sites.csv").then( function(markers){

let uniqueGroupings = [];

markers.forEach(item => {
// Step 3: Check if the 'grouping' value is not already in the uniqueGroupings array
    if (!uniqueGroupings.includes(item.Grouping)) {
        // Step 4: Add the 'grouping' value to the uniqueGroupings array
        uniqueGroupings.push(item.Grouping);
    }
});

if (filterContainer.innerHTML.trim() === "") {
    makeButtons(uniqueGroupings);
}


let buttons = document.querySelectorAll('.filter');

buttons.forEach(button => {
    button.addEventListener('click', () => {
        const selectedGrouping = button.getAttribute('id');

        // Filter the dataset based on the selected grouping

        buttons.forEach(btn => btn.classList.remove('selected'));

        button.classList.add('selected');

        let filteredData = [];

        if (selectedGrouping == "All") {
            filteredData = markers
        }
        else {
            filteredData = markers.filter(item => item.Grouping === selectedGrouping);
        }


        console.log(filteredData);

        // Redraw the dots with the filtered data
        redrawDots(filteredData);

    });
});

redrawDots(markers);

        });
});

}

let resizeTimer;


window.addEventListener("resize", function(){
  clearTimeout(resizeTimer);

  resizeTimer = setTimeout(function () {
    document.getElementById("map").innerHTML = "";
    drawMap();
    parent.postMessage(document.body.clientHeight, "*")
  }, 100);
});

drawMap();
parent.postMessage(document.body.clientHeight, "*")


    </script>
</body>

</html>
