<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://restofworld.org/wp-content/themes/orbis/static-assets/external/fonts.css">


    <style>

        body {
            margin: 0;
        }

        path {
            stroke-width: 0.5;
            stroke: #fff;
        }

        .point {
            stroke: #fff;
            stroke-width: 0.75;
        }


    .grabbing {
      cursor: grabbing;
    }
    
    .filter.selected {
        color: #fff;
        background-color: #E45E00;
    }
    
    p.description {
        font-size: 16px;
        margin: 5px 0;
    }
    
    p.attr {
        font-size: 12px;
    }
    
    #filter-container {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .filter {
        /* display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center; */
        padding: 7px 11px 6px;
        font-size: 13px;
        line-height: 13px;
        border-radius: 10px;
        border: none;
        background: #fff;
        width: max-content;
        /* transition: all .2s ease; */
        white-space: nowrap;
        cursor: pointer;
        user-select: none;
        border: 1px solid black;
        text-transform: uppercase;
        font-family: "Input Mono", sans-serif;
        transition: all 0.2 ease;

    }
    
    #All:hover:not(.selected) {
        background-color: #00000050;
    }
    #Shein:hover:not(.selected) {
        background-color: #D3221650;
    }
    
    #Temu:hover:not(.selected){
        background-color: #EF7F3150;
    }
    
    #TikTok:hover:not(.selected) {
        background-color: #9F7DFF50;
    }
    
    #Alibaba:hover:not(.selected) {
        background-color: #FF97FE50;
    }

    .selected {
        border: none;
    }
    
    #All.selected {
        color: #fff;
        background-color: #000000;
    }
    
    #Shein.selected {
        color: #fff;
        background-color: #D32216;
    }
    
    #Temu.selected {
        color: #fff;
        background-color: #EF7F31;
    }
    
    #TikTok.selected {
        color: #fff;
        background-color: #9F7DFF;
    }
    
    #Alibaba.selected {
        color: #fff;
        background-color: #FF97FE;
    }
    
    
    h1, h2, p{
        font-family: "Moderat",sans-serif;
      }
    
      h1 {
        font-size: 20px;
        text-align: center;

      }
    
      h2 {
        font-size: 14px;
        color: #666;
        font-weight: 400;
      }
    
    
      div.container {
        margin: 0;
        display: inline-block;
        width: fit-content;
      }
    
      div.table {
        padding: 0;
        display: flex;
        width: fit-content;
        flex-wrap: wrap;
      }
    
      div.table > p {
        margin: 5px 0;
        flex: 0 0 calc(50% - 10px);
      }
    
      span.label {
        font-size: 11px;
        display: block;
        color: #494949
      }

      .line {
        stroke-width: 1;
      }
    
        #tooltip {
            background-color: white;
            padding: 10px;
            border: 1px solid #a8a8a8;
            /* border-top: 5px solid #E45E00; */
            border-top: 5px solid black;
            border-radius: 4px;
            display: inline-block;
            position: fixed;
            width: 250px;
        }
        circle {
            cursor: pointer;
        }
        #body-container {
    width: 100%;
    overflow-x: hidden;

     /* max-width: 980px; Set a max-width to control the map's maximum size */
    
    }
#map-container {
    width: inherit;
    overflow-x: scroll;
    white-space: nowrap;
    direction: rtl; /* Right-to-left direction */

    @media screen and (max-width: 760px) {
     padding-left: 30%;
    }
    

}

div#close {
    text-align: center;
    border-top: 1px solid #666;
    padding-top: 5px;
    font-size: 10px;
    margin-top: 10px;
    font-family: "Moderat",sans-serif;
    text-transform: uppercase;
    font-weight: 100;
    color: #666;
    display: none;
    @media screen and (max-width: 760px) {
        display: block;
    }

}

#map {
  margin-top: 10px;
  margin: 0 auto;
  /* float: right; */
  overflow-x: scroll; /* Enable horizontal scrolling */
  overflow-y: visible;
  /* background-color: #262626; */

  direction: rtl; /* Right-to-left direction */
    @media screen and (max-width: 760px) {
     width: 1000px;
    }


}

p.dek {
    font-size: 14px;
    color: #666;
    text-align: center;
    margin-bottom: 10px;
  }

  p.cta {
    text-align: center;
    font-size: 12px;
    font-weight: bold;
  }
  p.credit {
    font-family: "Moderat",sans-serif;
    font-size: 11px;
    text-align: left;
    max-width: 500px;
    display: block;  }

    @media screen and (max-width: 760px) {


     p.description {
        font-size: 14px;
     }

     div.table > p {
        flex: 1 33%;
     }

     div.table > p:last-child {
        flex: 2 66%; /* The last item takes up 66% (twice the size of the first four) */
     }

     div.container {
        width: 100%;
     }

     #tooltip {
        width: 100%;
     }
    }


    </style>
</head>
<body>
    <div id="body-container">
        <h1>Moving away from China</h1>
        <p class="dek">Chinese e-commerce companies have become more international, both to operate closer to their customers, and to avoid anti-Chinese scrutiny.</p>
        <div id="filter-container"></div>
        <div id="tooltip" style="display: none;"></div>
        <p class="cta">Use dots for more information.</p>
        <div id="map-container">
            <svg id="map"></svg>
        </div>
        <p class="credit">Source: News reports</p>
        <p class="credit">Data research: Sherry Xiao</p>
          </div>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script>

function drawMap(){

    let width;
    let height;

    let svg;

    let svg_container;

    if (window.innerWidth > 760){
        svg_container = d3.select("#map").attr("viewBox", "0 0 1000 450");
        height = window.innerWidth / 2.25;
        width = window.innerWidth;
        svg = svg_container
    .attr("width", width)
    .attr("height",height)

    }
    else {
        svg_container = d3.select("#map").attr("viewBox", null);
        height = 450;
        width = 1000;
        svg = svg_container
    .attr("width", width)
    .attr("height",height)
    var scrollableDiv = document.getElementById('map');
        scrollableDiv.scrollLeft = scrollableDiv.scrollWidth - scrollableDiv.clientWidth;


    }





// Create an SVG element and set its dimensions
// const width = window.innerWidth;
// const height = window.innerHeight;

const chinaCenter = [104.1954, 35.8617]; 


    let colorDict = {
    "Shein":"#D32216",
    "Temu":"#EF7F31",
    "TikTok":"#9F7DFF",
    "Alibaba":"#FF97FE",
    "All":"#0043EF"
}

// Create a Mercator projection for the map


const projection = d3.geoNaturalEarth1(); //.rotate([-100, -15]);

// Create a path generator
const path = d3.geoPath().projection(projection);

function returnData(d){


return `<div class="container ${d.Grouping}">
    <p class="description">${d.Description}</p>   
    <div class="table">
    <p class="attr"><span class="label">App</span> ${d.App}</p>
    <p class="attr"><span class="label">Company</span> ${d['Parent company']}</p>    
    <p class="attr"><span class="label">Location</span> ${d.Location}</p>   
    <p class="attr"><span class="label">Year</span> ${d.Year}</p>   
    <p class="attr"><span class="label">Function</span> ${d.Classification}</p>  
    </div>
    <div id="close">Close</div>
 </div>
    `
}

let filterContainer = document.getElementById('filter-container');


function makeButtons(companyNames) {
            let element = 'All'
            let button = document.createElement('button');
                button.className = `filter selected`;
                button.id = `${element}`;
                button.textContent = element;
                filterContainer.appendChild(button);

            for (let index = 0; index < companyNames.length; index++) {
                let element = companyNames[index];
                let button = document.createElement('button');
                button.className = `filter`;
                button.id = `${element}`;
                button.textContent = element;
                filterContainer.appendChild(button);
            }

        }




function hideTooltip() {
    d3.select("#tooltip")
        .style("display", "none");
}






// Load the world map data
d3.json("world_2.json").then(function (world) {
    // Append the countries to the SVG
    svg.selectAll("path")
        .data(world.features)
        .enter()
        .append("path")
        .attr('class','countries')
        .attr("d", path)
        .attr('fill',(d) => (d.properties.name == 'China' ? "#0043EF" : "#d4d4d4"))


        function showTooltip(event,d) {
    // Get the coordinates for the tooltip
    let x, y, where_pos;

    if (isTouchDevice){
        x = 0;
        y = 0;
        where_pos = 'bottom';
    }

    else {
        x = event.clientX + 10;
        y = event.clientY + 10;
        where_pos = "top";

        let containerWidth = document.getElementById('map-container').clientWidth;

        if (x > containerWidth / 2) {
            x = x - 280;
        }

    }

    
    // Show the tooltip at the coordinates
    



    d3.select("#tooltip")
        .style("display", "block")
        .style("left", (x) + "px")
        .style(where_pos, (y) + "px")
        .html(returnData(d));


    

    // if (document.getElementById('map-container').clientWidth < 980) {
    // }
    // else {
    //     if (x >= containerWidth){
    //     d3.select("#tooltip")
    //     .style("display", "block")
    //     .style("left", (x - 280) + "px")
    //     .style("top", (y + 20) + "px")
    //     .html(returnData(d));
    //     }
    //     else {
    //         d3.select("#tooltip")
    //         .style("display", "block")
    //         .style("left", (x + 20) + "px")
    //         .style("top", (y + 20) + "px")
    //         .html(returnData(d));

    //     }

    // }




}

let listOfCountries = [];


        function return_Centeroid(country_name){

            // let padding = 0;

            // let paddingBase = 5;
            
            // const count = listOfCountries.reduce((accumulator, currentValue) => {
            // if (currentValue === country_name) {
            //     console.log(country_name)
            //     return accumulator + 1;
            // }
            // return accumulator;
            // }, 0);




            // if (count >= 1) {
            // // Value exists in the array

            //     if(count >= 2) {
            //         padding = -paddingBase;
            //     }
            //     else {
            //         padding = paddingBase;
            //     }
            // } else {
            // // Value does not exist in the array
            //     padding = 0;
            // }

            // listOfCountries.push(country_name);



simp_country = world.features.find(function(nation) {
    return nation.properties.name === country_name;
});


country = path.centroid(simp_country)

return country;


}

const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;


function redrawDots(data,key){



    // hideTooltip();

svg.selectAll(".point").remove();

svg.selectAll(".line").remove();



     function getArch(source,target) {
        var dx = target[0] - source[0],
            dy = target[1] - source[1],
            dr = Math.sqrt(dx * dx + dy * dy);
        return "M" + source[0] + "," + source[1] + "A" + dr + "," + dr +
    " 0 0,1 " + target[0] + "," + target[1];
    }


    var paths = svg.selectAll(".line")
    .data(data,  function(d) {
        return d.Location + d.Grouping; // Use Location and Grouping as the key
    })
    .enter()
    .append("path")
    .attr("class", "line")
    .attr('data-city', (d) => d.Location)
    .attr("d", function(d) {
        var coords = return_Centeroid(d.Location);
            return getArch(projection(chinaCenter),coords);
        })
    .style("stroke", function (d) { return colorDict[d.Grouping]})
    .style('fill',"none");

    var previousCoordinates = {};

    var multipleSites = [];

    let countriesSelected = [];

    let grouping;

    let country_color = colorDict[key];;


    var points = svg.selectAll(".point")
    .data(data,  function(d) {
        grouping = d.Grouping;
        countriesSelected.push(d.Location);
        return d.Location + d.Grouping; // Use Location and Grouping as the key
    })
    .enter()
    .append("circle")
    .attr("class", "point")
    .attr('data-city', (d) => d.Location)
    .attr("r", 5)    
    .attr("cx", function (d) {
    var coords = return_Centeroid(d.Location);
    

        // Check if coordinates for this location were used before
    if (previousCoordinates[d.Location]) {
      // Spread the new point 5 pixels around the previous point

      multipleSites.push(d.Location);

    //   if(d.Location == "Singapore"){
    //     coords[0] = previousCoordinates[d.Location][0] + 5;
    //   }
    //   else{
    //     coords[0] = previousCoordinates[d.Location][0] + 10;
    //   }

    }


    // Store the current coordinates as the previous coordinates
    previousCoordinates[d.Location] = coords;


    return coords[0]; // Set the X-coordinate using cx
  })
  .attr("cy", function (d) {
    var coords = return_Centeroid(d.Location);
    return coords[1]; // Set the Y-coordinate using cy
  })
    .style("fill", function (d) {return colorDict[d.Grouping]})

    // multipleSites = [...new Set(multipleSites)];

    var siteCounts = {};

    // Loop through the array to count occurrences
    multipleSites.forEach(function (site) {
        if (!siteCounts[site]) {
            siteCounts[site] = 2; // Initialize the count if it doesn't exist
        } else {
            siteCounts[site]++; // Increment the count if the site already exists
        }
    });

    let uniqueKeys = [];

    // Loop through the array to extract keys
    multipleSites.forEach(function (site) {
        if (!uniqueKeys.includes(site)) {
            uniqueKeys.push(site);
        }
    });




// Define the radius of the circle

    let radius, centralX, centralY = 0;

    uniqueKeys.forEach(function(site, index) {
        
    // Select the dots (you may want to use a specific class or ID)
        var dots = d3.selectAll('circle[data-city="' + site + '"]');

        centralX = previousCoordinates[site][0];
        centralY = previousCoordinates[site][1];

        if (siteCounts[site] > 2){
            if (siteCounts[site] > 4){
                radius = 8;
            }
            else {
                radius = 6;
            }
        }
        else {
            radius = 5;
        }

        // Calculate the angle increment between each dot
        var angleIncrement = (2 * Math.PI) / dots.size();

        // Iterate through the dots and position them in a circle
        dots.each(function(d, i) {
            var dot = d3.select(this);
            
            // Calculate the angle for this dot
            var angle = i * angleIncrement;
            
            // Calculate the dot's position based on the central point, radius, and angle
            var x = centralX + radius * Math.cos(angle);
            var y = centralY + radius * Math.sin(angle);
            
            // Set the new position for the dot
            dot.attr("cx", x)
            .attr("cy", y);
        });

        var line = d3.selectAll('path[data-city="' + site + '"]');

        console.log(line[0]);

        line.each(function(d, i) {
            var dot = d3.select(this);
            
            // Calculate the angle for this dot
            var angle = i * angleIncrement;
            
            // Calculate the dot's position based on the central point, radius, and angle
            var x = centralX + radius * Math.cos(angle);
            var y = centralY + radius * Math.sin(angle);
            
            // Set the new position for the dot
            dot.attr("d", function(d) {
            return getArch(projection(chinaCenter),[x,y]);
            })
        });




    })

    function returnColor(d){
        if (countriesSelected.includes(d.properties.name)){
            return `#E45E0050`;
        }
        else if (d.properties.name == 'China'){
            return '#E45E00';
        }
        else {
            return "#d4d4d4";
        }
    }

 

    svg.selectAll("path.countries")
    .attr('fill',(d) => returnColor(d))
    

    console.log(multipleSites);


    if (isTouchDevice) {
    // Handle touch events (e.g., tap or touchstart)
    svg.selectAll(".point").on('touchstart', function (event, d) {
    showTooltip(event,d);
    })
    } else {
    // Handle mouse events (e.g., mouseover)
    svg.selectAll(".point")
    .on("mouseover", function (event, d) {
    showTooltip(event,d);
    })
    .on("mouseout", hideTooltip);
        // Your mouse event handling logic here
    };
    








}



        d3.csv("sites.csv").then( function(markers){

let uniqueGroupings = [];

markers.forEach(item => {
// Step 3: Check if the 'grouping' value is not already in the uniqueGroupings array
    if (!uniqueGroupings.includes(item.Grouping)) {
        // Step 4: Add the 'grouping' value to the uniqueGroupings array
        uniqueGroupings.push(item.Grouping);
    }
});

if (filterContainer.innerHTML.trim() === "") {
    makeButtons(uniqueGroupings);
}


let buttons = document.querySelectorAll('.filter');

buttons.forEach(button => {
    button.addEventListener('click', () => {
        const selectedGrouping = button.getAttribute('id');

        // Filter the dataset based on the selected grouping

        buttons.forEach(btn => btn.classList.remove('selected'));

        button.classList.add('selected');

        let filteredData = [];

        if (selectedGrouping == "All") {
            filteredData = markers
        }
        else {
            filteredData = markers.filter(item => item.Grouping === selectedGrouping);
        }



        // Redraw the dots with the filtered data
        redrawDots(filteredData,selectedGrouping);

    });
});

redrawDots(markers,"All");

        });
});

}

let resizeTimer;


window.addEventListener("resize", function(){
  clearTimeout(resizeTimer);
  parent.postMessage(document.body.clientHeight, "*")

  resizeTimer = setTimeout(function () {
    document.getElementById("map").innerHTML = "";
    drawMap();
  }, 100);
});

var tooltip = document.getElementById("tooltip");

document.addEventListener("click", function (event) {


    var target = event.target;

    // Check if the click target is not a point (circle) element or the tooltip itself
    if (!target.classList.contains("point") && target !== tooltip) {
        // Close the tooltip by hiding it
        tooltip.style.display = "none";
    }
});


drawMap();
parent.postMessage(document.body.clientHeight, "*")


    </script>
</body>

</html>
